<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
</style>
<h1>更新</h1>
<ul>
<li>deploy.py line506 不更新系统的软件包 (该条应该可以不更改)</li>
<li>胡乱添加一些中文注释</li>
<li>预先设定问题和答案 (Ubuntu16.04程序测试通过)</li>
<li>
<p>一定要输入邮箱，否则可能出错(会无法获得证书)</p>
</li>
<li>
<p>修复locale语言环境配置问题（部分ubuntu16.04下更新证书会失败）<br />
sudo /usr/share/locales/install-language-pack en_US.UTF-8<br />
sudo apt-get install language-pack-zh-hant-base language-pack-zh-hans-base  </p>
</li>
</ul>
<h1><a href="https://github.com/aploium/zmirror">zmirror</a> 一键部署脚本</h1>
<p>使用<a href="https://github.com/aploium/zmirror">zmirror</a>快速部署镜像的脚本  </p>
<p>如果无法部署成功, 可以尝试手动部署: <a href="https://github.com/aploium/zmirror/wiki/%E9%83%A8%E7%BD%B2%E6%94%AF%E6%8C%81HTTPS%E5%92%8CHTTP2.0%E7%9A%84%E9%95%9C%E5%83%8F">手动部署zmirror</a><br />
或尝试<a href="https://github.com/aploium/zmirror-onekey/issues/18">由yumin9822提供的脚本</a>  </p>
<h2>前置需求</h2>
<ol>
<li>一台墙外VPS, OpenVZ/Xen/KVM均可  </li>
<li>操作系统:    <ul>
<li>支持的操作系统:  <ul>
<li>Ubuntu 14.04/15.04(不支持HTTP2)/15.10/16.04+  </li>
<li>Debian 8 (不支持HTTP/2)  </li>
<li><strong>不支持</strong> CentOS/RHEL/Windows/Fedora/Arch/...
  对于这些系统, 可以使用<a href="https://github.com/aploium/zmirror-onekey/issues/18">由yumin9822提供的这个脚本</a>  </li>
</ul>
</li>
<li>推荐的操作系统:  <ul>
<li>Ubuntu 16.04 x86_64</li>
</ul>
</li>
<li>全新(刚安装完成)的操作系统. 如果系统中有其他东西, 可能会产生冲突   </li>
<li>root权限  </li>
</ul>
</li>
<li>
<p>域名</p>
<ul>
<li>每个镜像要求一个三级域名(类似于<code>g.zmirrordemo.com</code>这样的, 有三部分, 两个点)  </li>
<li>域名已经在DNS记录中正确指向你的VPS</li>
</ul>
<blockquote>
<p><strong>提示</strong><br />
如果你没有自己的域名, 请看<a href="#我没有自己的域名">FAQ-我没有自己的域名</a>  </p>
</blockquote>
</li>
</ol>
<h2>运行方法</h2>
<ul>
<li>
<p><strong>我没有SSL证书 (如果不懂, 请使用这个)</strong>
    <code>bash
    sudo apt-get -y update &amp;&amp; sudo apt-get -y install python3 git
    git clone https://github.com/aploium/zmirror-onekey.git --depth=1
    cd zmirror-onekey
    sudo python3 deploy.py</code>
    然后按照脚本给予的提示继续, 过程中会自动获取SSL证书<br />
    如果有不懂的, 可参考下面的安装视频<br />
    如果遇到bug, 请<a href="https://github.com/aploium/zmirror-onekey/issues">发issues</a>提出  </p>
</li>
<li>
<p><strong>我已有SSL证书</strong><br />
    如果已有证书, 希望使用自己提供的证书, 而不是通过 let's encrypt 获取<br />
    请将上面代码中的第四行替换成下面的样子, 在运行期间会提示你输入证书路径的:<br />
<code>bash
    sudo python3 deploy.py --i-have-cert</code></p>
<blockquote>
<p><strong>警告</strong><br />
不支持加密的私钥, 如果私钥有密码加密, 请先解密  </p>
</blockquote>
</li>
</ul>
<h2>安装过程视频</h2>
<p>请点击下面的图片打开<br />
"视频"中的文字可以被选中和复制<br />
<a href="https://asciinema.org/a/85170"><img alt="Installation demo of zmirror-onekey" src="https://asciinema.org/a/85170.png" /></a></p>
<h2>特性</h2>
<ul>
<li>支持一次部署多个镜像, 支持同VPS多镜像  </li>
<li>自动安装 <a href="https://letsencrypt.org/">let's encrypt</a> 并申请证书, 启用HTTPS  </li>
<li>自动添加 let's encrypt 的定期renew脚本到crontab  </li>
<li>启用<a href="https://zh.wikipedia.org/wiki/HTTP/2">HTTP/2</a> ps:Debian8和Ubuntu15.04不支持HTTP/2  </li>
<li>启用<a href="https://zh.wikipedia.org/zh-cn/HTTP%E4%B8%A5%E6%A0%BC%E4%BC%A0%E8%BE%93%E5%AE%89%E5%85%A8">HSTS</a>  </li>
</ul>
<h2>FAQ</h2>
<ol>
<li>
<h4>有没有部署完成的Demo?</h4>
<p>当然有, 请戳 <a href="https://github.com/aploium/zmirror#demo">zmirror-demo</a>  </p>
</li>
<li>
<h4>我没有自己的域名</h4>
<p>有一些提供免费(也没有注册门槛)域名的注册商<br />
比如最有名的 <a href="http://www.dot.tk/">.tk 域名</a><br />
可以快速注册免费的域名  </p>
<blockquote>
<p><strong>注意</strong><br />
请不要使用 .cf 和 .ga 域名, letsencrypt对它们的支持非常差, 经常出现无法下发证书的问题<br />
除非不得已, 在使用免费域名时, 请使用老牌的 .tk 域名  </p>
</blockquote>
</li>
<li>
<h4>安装完成后各个程序的文件夹在哪?</h4>
<ul>
<li><em>zmirror</em><br />
    安装在 <code>/var/www/镜像名</code> 文件夹下<br />
    镜像名为每个镜像的名字, 比如YoutubePC就是 <code>/var/www/youtubePC</code>  </li>
<li><em>let's encrypt</em><br />
    本体在: <code>/etc/certbot/</code><br />
    申请到的证书位置, 请看 <a href="https://certbot.eff.org/docs/using.html#where-are-my-certificates">certbot文档-where-are-my-certificates</a></li>
<li>
<p><em>Apache</em><br />
    Apache的配置文件在<code>/etc/apache2/</code>下<br />
    其中各个站点的配置文件在<code>/etc/apache2/sites-enabled/</code>  </p>
<p>Apache日志文件在<code>/var/log/apache2/镜像名_后缀.log</code><br />
后缀为 _error 的日志文件中, 同时包含了stdout的输出(无论是否是错误), 对debug会有帮助  </p>
</li>
</ul>
</li>
<li>
<h4>为什么安装的是Apache, 而不是Nginx, 我可以选择吗?</h4>
<p>因为Apache的wsgi对python更友好<br />
而且Nginx没有Visual Host功能<br />
在性能上, 由于性能瓶颈是zmirror本身, 所以Apache和Nginx之间的性能差距可以被忽略  </p>
<p>目前一键脚本只能安装Apache, 不支持Nginx, 也没有支持Nginx的计划, 如果需要Nginx, 请手动部署<br />
手动部署可以参考 <a href="https://github.com/aploium/zmirror/wiki">zmirror wiki</a><br />
当然, 如果你能写一份Nginx部署教程, 我会很感谢的~ :)  </p>
</li>
<li>
<h4>安装的Apache版本?</h4>
<p>在Ubuntu中, 使用的是 PPA:ondrej/apache2 理论上应该是最新版, 或者接近最新版(2.4.23+)<br />
在Debian8中, 使用系统的 apt-get 安装, 版本比较旧, 所以Debian不支持HTTP/2  </p>
</li>
<li>
<h4>Let's encrypt 证书自动更新?</h4>
<p>安装脚本会自动创建定期更新证书的脚本, 脚本位置为 <code>/etc/cron.weekly/zmirror-letsencrypt-renew.sh</code>  </p>
</li>
<li>
<h4>证书有效期为什么只有90天?</h4>
<p>主要是因为Let's encrypt认为, 证书的申请和部署可以自动化时, 90天足够了.<br />
具体可以看<a href="https://community.letsencrypt.org/t/pros-and-cons-of-90-day-certificate-lifetimes/4621">这个官方说明</a>(可能需要自备梯子)<br />
本安装脚本会在linux定时任务(crontab)中加入自动续期的脚本, 不用担心证书过期<br />
即使自动续期脚本万一失效了, let's encrypt也会在快要过期时邮件通知你  </p>
</li>
<li>
<h4>其他高级功能, 比如说CDN, 在哪?</h4>
<p>这个脚本只提供最基础的部署, 高级功能需要手动配置<br />
请看<a href="https://github.com/aploium/zmirror/blob/master/config_default.py">config_default.py</a>和<a href="https://github.com/aploium/zmirror/blob/master/custom_func.sample.py">custom_func.sample.py</a>中的说明  </p>
<p>如果想用CDN, 可以看这个教程<a href="https://github.com/aploium/zmirror/wiki/%E4%BD%BF%E7%94%A8%E4%B8%83%E7%89%9B%E4%BD%9C%E4%B8%BAzmirror%E9%95%9C%E5%83%8F%E7%9A%84CDN">使用七牛作为zmirror镜像CDN</a>  </p>
<blockquote>
<p><strong>警告</strong><br />
如果你想要修改<code>config_default.py</code>中的某项设置, 请不要直接修改<br />
而应该将它复制到<code>config.py</code>中, 然后修改<code>config.py</code>里的设置<br />
<code>config.py</code>中的设置会覆盖掉<code>config_default.py</code>中的同名设置<br />
除非你是开发者, 否则无论如何都不应该修改<code>config_default.py</code>  </p>
</blockquote>
</li>
<li>
<h4>网速太慢?</h4>
<p>如果你的VPS提供商允许的话, 可以试试看<a href="https://github.com/snooda/net-speeder">net-speeder</a>  </p>
<p>或者换一个网速快的VPS, Demo站使用的VPS是<a href="https://clientarea.ramnode.com/aff.php?aff=2990">Ramnode</a><br />
服务器地点是LA(Los Angeles), 速度相当快.<br />
ps: 如果你也想试试看的话, 请点击<a href="https://clientarea.ramnode.com/aff.php?aff=2990">这个链接</a>进入, 这里有我的推广小尾巴, 你买了的话我会有一丢丢(好像是10%)分成<br />
ramnode允许使用net-speeder  </p>
</li>
<li>
<h4>证书获取失败</h4>
<p>脚本使用<a href="https://letsencrypt.org/">Let's encrypt(certbot)</a>来获取证书  </p>
<p>certbot 会在本地 Listen 80 或者 443 端口, 然后由远程授权服务器根据<strong>域名的<a href="https://support.dnspod.cn/Kb/showarticle/tsid/30/">A记录</a></strong>来<strong>访问本机</strong><br />
当远程服务器成功连接到本机的certbot客户端后, 就会颁发证书.<br />
详细流程请看官方文档<a href="https://letsencrypt.org/how-it-works/">How It Works</a>  </p>
<p>证书获取失败最有可能的原因是域名记录设置后<a href="https://support.dnspod.cn/Kb/showarticle/tsid/53/">尚未来得及生效</a>, 域名DNS记录的生效通常需要数分钟以上, 最长可达<em>72小时</em><br />
对于这种情况, 除了等待以外是没有什么办法的.<br />
本脚本在默认的5次尝试失败后, 会提示是否一直尝试下去, 如果你确认DNS记录已经正常设置, 请在提示<br />
<code>max retries exceed, do you want to continue retry infinity?(Y/n)</code><br />
时, 选择Y, 一般数分钟内就能成功.  </p>
<p>如果不能确定是否正常设置, 可以访问 https://www.whatsmydns.net/ , 这个网站可以在全球范围内查询A记录<br />
如果查询出的A记录与你的IP相同, 就表示设置成功了, 此时只需要让脚本自行尝试即可<br />
如果此时仍然多次尝试失败, 请看下面的<code>手动运行lets encrypt获取证书</code>部分  </p>
<blockquote>
<p><strong>手动运行lets encrypt获取证书</strong><br />
如果能确认DNS记录已经设置正常, 但是仍然无法获取证书, 请尝试手动运行letsencrypt获取证书:</p>
<p><code>bash
sudo service apache2 stop
sudo /etc/certbot/certbot-auto certonly --standalone -d "你的域名1"
sudo /etc/certbot/certbot-auto certonly --standalone -d "你的域名2"
sudo service apache2 start</code></p>
<p>或者(如果上面的仍然失败)<br />
<code>bash
sudo apt-get install letsencrypt
sudo service apache2 stop
sudo letsencrypt certonly --standalone -d "你的域名1"
sudo letsencrypt certonly --standalone -d "你的域名2"
sudo service apache2 start</code></p>
<p>并在手动获取证书成功后再次运行本脚本  </p>
</blockquote>
</li>
<li>
<h4>更新zmirror</h4>
<p>请运行以下代码(假设<code>zmirror-onekey</code>是本脚本文件夹):<br />
<code>bash
cd zmirror-onekey
git pull
sudo python3 deploy.py --upgrade-only</code>
注意: 更新zmirror以后会自动重启Apache  </p>
</li>
</ol>